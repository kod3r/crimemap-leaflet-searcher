/*! Copyright (C) 2014 Miroslav Bimbo <mbi@eea.sk>
*
* This file is part of Crimemap.
*
* Crimemap is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* Crimemap is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with Crimemap. If not, see <http://www.gnu.org/licenses/>.
*
/L.CrimemapLeafletSearcher=function(a){function b(){m.selectAll(".place").classed({active:!1,inactive:!1}).style("display","inline-block")}function c(){m.selectAll(".place").classed({active:!1,inactive:!0})}function d(a){d3.select(a).classed({active:!0,inactive:!1})}function e(a){i(a),c(),d(this),q.style("display","inline-block"),p.style("display","inline-block"),m.selectAll(".place").style("display","none"),r.style("display","none")}function f(){q.style("display","none"),p.style("display","none"),m.selectAll(".place").style("display","inline-block"),r.style("display","inline-block")}function g(){p.style("display","none"),q.style("display","none"),n.style("display","inline-block"),r.style("display","inline-block")}function h(){p.style("display","inline-block"),m.select(".place").empty()||(q.style("display","inline-block"),m.selectAll(".place").style("display","none")),n.style("display","none"),r.style("display","none")}function i(b){var c=b.boundingbox,d=L.latLng(c[1],c[3]),e=L.latLng(c[0],c[2]),f=L.latLngBounds(d,e);a.fitBounds(f,{maxZoom:a.getMaxZoom()})}function j(){l=d3.select(a.getContainer()).append("div").attr("id","placeChooser"),m=l.append("div").attr("id","innerBox"),n=m.append("form").attr("id","searchForm").style("display","none").on("submit",u.search),n.append("input").attr("type","text").attr("id","searchTerm"),n.append("input").attr("type","submit").attr("value","Hľadať").attr("id","searchSubmit"),o=n.append("span").attr("id","processing"),p=m.append("span").attr("id","enterNewSearch").text("Vyhľadať lokalitu").on("click",g),q=m.append("span").attr("id","chooseAnother").style("display","none").text("Zobraziť vyhľadané").on("click",f),r=m.append("span").attr("id","cancelSearch").style("display","none").text("Zrušiť").on("click",h)}var k,l,m,n,o,p,q,r,s=10,t="http://nominatim.openstreetmap.org/search",u={};return u.search=function(){d3.event.preventDefault();var a=this[0].value.trim().replace(/\s+/g,"+");o.attr("class","normalinfo").text("Vyhladavam"),d3.json(t+"?q="+a+"&format=json&countrycodes=sk").get(function(a,c){if(null!==a)return void o.attr("class","errorinfo").text("Vyhladavanie zlyhalo");c=c.slice(0,s);var d=m.selectAll(".place").data(c);if(d.exit().remove(),c.length>0){o.attr("class","").text(""),n.style("display","none");{d.enter().append("span").classed({place:"true"}).on("click",e),d.text(function(a){return a.display_name.replace(/Region of/g,"Kraj").replace(/Slovakia/g,"Slovensko").replace(/Eastern/g,"Východné").replace(/Western/g,"Západné").replace(/Central/g,"Stredné").replace(/District of/g,"Okres")})}i(c[0])}else o.attr("class","normalinfo").text("Nenasiel sa ziaden vysledok");b(),r.style("display","inline-block")})},u.renderFunction=function(a){return arguments.length?(k=a,u):k},u.results=function(a){return arguments.length?(s=a,u):s},j(a),u};